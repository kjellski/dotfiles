#!/bin/bash
VERBOSE=0;
# store the folder we're coming from, we'll restore this eventually
SCRIPT_BASEFOLDER="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# load logging
. $SCRIPT_BASEFOLDER/lib/log.sh

# ----------------------------------------------------------------------------
# arguments
# ----------------------------------------------------------------------------
function usage() {
    cat << EOF
usage: dotfiles [-h|--help] [-v|--verbose] [(-p|--profile) <profile>]

This programm is used to create or copy terminal and editor dotfiles from the choosen profiles folder to the \${HOME} folder.
The default profile is compatible. This is normally giving a [~]$ like promt, a bit of bash colors and default vim settings to behave sane.

Arguments:
    -p | --profile  usese the given profile
    -v | --verbose  shows verbose output
    -h | --help     displays this text

    
EOF
}

# use getopts for command line arguments and option parsing.
# good link: http://aplawrence.com/Unix/getopts.html
while [ "$1" != "" ]
do
    case $1 in
        -v | --verbose )
            VERBOSE=1
            ;;
        -h | --help ) 
            usage
            exit 
            ;;
        * )
            usage
            error "illigal option: \"$1\", aborting."
            exit 1
    esac
    shift
done

# ----------------------------------------------------------------------------
# basic setup
# ----------------------------------------------------------------------------
DEPLOY_DIR=/tmp #this will be $HOME after testing
info "this scipt will deploy to this folder: ${DEPLOY_DIR}"

NOW=`date +"%F_%T"` # used to form the backup folder for this run.
BACKUP_FOLDER=$DEPLOY_DIR/backups/$NOW
info "backup folder is: ${BACKUP_FOLDER}"

# think for future profiles feature, not too coasty
DEFAULT_PROFILE=profiles/compatible
PROFILE=$DEFAULT_PROFILE
PROFILE_FOLDER=$SCRIPT_BASEFOLDER/$PROFILE
info "using profile ${PROFILE}, therefor folder: ${PROFILE_FOLDER}"

# ----------------------------------------------------------------------------
# functions to help actually do stuff
# ----------------------------------------------------------------------------
# function to create the backup folder, if existing, does nothing.
function create_backup_folder() {
    if [ ! -d $BACKUP_FOLDER ]; then
        mkdir -p $BACKUP_FOLDER
        log "created backup folder: $BACKUP_FOLDER"
    fi
}

# function to backup the given file
function backup_file ()
{
    # create the backup folder
    create_backup_folder
    
    # is the file existing? if so, exist, don't do harmful shit here...
    if [ -e $BACKUP_FOLDER/$1 ]; then
        error "the file $1 was existing in the backup folder. won't go on, would mean we are overriding existing files. do that harm yourself please."
        log "[FAILURE]"
        exit -1
    fi
    cp -i $1 $BACKUP_FOLDER
}

# deploys the file given as argument to $DEPLOY_DIR
function deploy_file () {
    # if the file exists, back it up, no matter what
    backup_file $DEPLOY_DIR/.$1
    # copy the file from profiles folder over to deploy folder
    cp -i $PROFILE_FOLDER/$1 $DEPLOY_DIR/.$1
    if [ $? -eq 1 ]; then
        warn ".$1 NOT deployed"
    else
        info "$PROFILE_FOLDER/$1 deployed to $DEPLOY_DIR/.$1"
    fi
}

# ----------------------------------------------------------------------------
# deploy files for profile
# ----------------------------------------------------------------------------
for file in $PROFILE_FOLDER/* ; do
    deploy_file ${file##*/}
done

log "[SUCCESS]"
# correctly exist the program with the last commands exit code.
exit
